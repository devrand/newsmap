<!DOCTYPE html>
<meta charset="utf-8">

<head>

    <title>Result!</title>
<link href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz&amp;subset=cyrillic" rel="stylesheet"> 
    <style>

        body {
            font: 10px sans-serif;
        }


        h2 {
            font-size: 22px;
        }

        div {
            margin-top: 35px;
            margin-bottom: 0px;
            margin-left: 150px;
        }

        p {
            font-family: sans-serif;
            font-size: 14px;
        }

        @font-face {
  		font-family: droid-mono;
  		src: url(DroidSansMono.ttf)
	}

    </style>
</head>

<body>

<div>




</div>

<script src="d3.v5.min.js" charset="utf-8"></script>
<script>

    // Global variables
    var anchor_array = [],
            label_array = [],
            margin = {top: 20, right: 50, bottom: 50, left: 150},
            width = 1500 - margin.left - margin.right,
            height = 1200 - margin.top - margin.bottom,
            x_mean = width / 2,
            y_mean = height / 2,
            offset = 4,
            radius = 7;

      const words_per_row = 3;
      const nrows = 3;
      const font_size_s = 11;
      const font_size_b = 28;
      const main_font = "droid-mono";
      const second_font = "Yanone Kaffeesatz";
      const between_lines_interval = 0.1;
      // const colors = ['#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462'];
      // const colors = ['#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02'];
      // const colors = ["#60e3ad", "#c1498c", "#4623a3", "#c1e64e", "#3a87cd", "#7d5aad"];


      const colors = {};
      const color_codes = ["#a03532", "#c1498c", "#4623a3", "#643c5a", "#3a87cd", "#05b66d"];
      const class_names = ["Влада/політики", "Війна", "Росія", "Про Україну", "Новини з соцмереж", "Церква"];
      class_names.map(function(d, i){ colors[d] = color_codes[i] });

    var anchor_data, labels, circ, links, bounds;
    var canvas, context;

    var k = 1;  // zoom level

    function zoomed(){
      context.save();
 	    context.clearRect(0, 0, width, height);
      context.translate(d3.event.transform.x, d3.event.transform.y);
  	  context.scale(d3.event.transform.k, d3.event.transform.k);
  	  k = d3.event.transform.k;
  	  drawLabels(k);
  	  context.restore();
      // https://github.com/d3/d3-zoom#transform_invert
       console.log("scale: ", k, "zoom transform: ", d3.event.transform.x, d3.event.transform.y);
    }



    function drawLabels(k){
        var font_size;
        context.clearRect(0, 0, width, height);
        

        for (var i = 0; i < label_array.length; i++) {

            context.fillStyle = label_array[i].color;

            if(label_array[i].level < 3){ // in case of topic names

 	      //context.clearRect( label_array[i].x, label_array[i].y,  
	      //			 label_array[i].width, label_array[i].height);
              font_size = font_size_b;
              ////// if(k < 0.75){ font_size = font_size_b }
              font_size = font_size - 10*(label_array[i].level - 1);

              context.font = `${font_size}px "${main_font}"`;

              context.fillText(label_array[i].name, label_array[i].x, label_array[i].y - 0.8*font_size);
 // - font_size / (label_array[i].level == 2 ? 1 : 2));
/*
               context.beginPath();
	          context.rect(label_array[i].x, label_array[i].y - label_array[i].height, 
	           		label_array[i].width, label_array[i].height);
		       context.lineWidth = 1;
		       context.strokeStyle = 'black';
		       context.stroke();
		       context.closePath();
*/

            } else {  //news items
              if(k > 0.5){
              	font_size =  Math.floor(Math.sqrt( (font_size_s * k) )); 
              	context.font = `${font_size}px "${second_font}"`;
              	var boo = label_array[i]; 
              	//context.fillText(boo.rows[0].join(' '), boo.x, boo.y);


              	for(var j = 0; j < boo.rows.length; j++){
                        var row = boo.rows[j].join(' ');
			if( j == nrows-1 ){  // add ... in case we've trimmed name 
					     // TODO:  change it in data preparation script
                          row += ' ...';
                        }
                	
			context.fillText(row, 
						boo.x, 
						boo.y - boo.height + j * font_size * (1+between_lines_interval));

              	}
              	// and site name
                context.font = `${font_size}px "${second_font}"`;
                context.fillStyle = 'gray';
				        context.fillText(boo.url, boo.x, 

					         boo.y - boo.height + j * font_size * (1 + between_lines_interval));
/*
          // draw box around text, for debugging      
			    context.beginPath();
	        context.rect(label_array[i].x, label_array[i].y - label_array[i].height - font_size, 
	          		label_array[i].width, label_array[i].height);
		      context.lineWidth = 0.5;
		      context.strokeStyle = 'red';
		      context.stroke();
		      context.closePath();
*/
              } 

            }


        }


     }


    // Functions
     function zoom_to(x, y, k){
	var zoommer = function(){

      	    context.save();
 	    context.clearRect(0, 0, width, height);
	    context.translate(x, y);
	    context.scale(k, k);
      	    drawLabels(k);
  	    context.restore();

	};

        return zoommer;

     }




    d3.json("./labels.json").then(function(data) {
      //if (error) console.log(error);
      //console.log(data);
      label_array = data;
      canvas = d3.select("body").append("canvas")
            .attr("width", width)
            .attr("height", height);

      context = canvas.node().getContext("2d");

      canvas.call(d3.zoom()
         .scaleExtent([0.5, 4])
           .on("zoom", zoomed));

      (zoom_to(60, 155, 0.5))();
      //drawLabels(1);

//      var x1=-534, y1=-1470, k1=3.5;
//      setTimeout(zoom_to(x1, y1, k1), 2000);

    });


</script>
