<!DOCTYPE html>
<meta charset="utf-8">

<head>

    <title>Result!</title>
<link href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz&amp;subset=cyrillic" rel="stylesheet"> 
    <style>

        @font-face {
  		font-family: droid-mono;
  		src: url(DroidSansMono.ttf)
	}

    </style>
</head>

<body>


<script src="d3.v5.min.js" charset="utf-8"></script>
<script>

    // Global variables
    var anchor_array = [],
            label_array = [],
            margin = {top: 20, right: 20, bottom: 20, left: 20},
            width = window.innerWidth - margin.left - margin.right,
            height = window.innerHeight - margin.top - margin.bottom,
            x_mean = width / 2,
            y_mean = height / 2,
            offset = 4,
            radius = 7;

      const words_per_row = 3;
      const nrows = 3;
      const font_size_s = 11;
      const font_size_b = 28;
      const main_font = "droid-mono";
      const second_font = "Yanone Kaffeesatz";
      const between_lines_interval = 0.1;
      //const color_codes = ['#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462'];
      const color_codes = ['#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02'];
      //const color_codes = ["#60e3ad", "#c1498c", "#4623a3", "#c1e64e", "#3a87cd", "#7d5aad"];


      const colors = {};
      const class_names = ["#a03532", "#c1498c", "#4623a3", "#643c5a", "#3a87cd", "#05b66d"];
      //const class_names = ["Влада/політики", "Війна", "Росія", "Про Україну", "Новини з соцмереж", "Церква"];
      class_names.map(function(d, i){ colors[d] = color_codes[i] });

    var anchor_data, labels, circ, links, bounds;
    var canvas, context;

    var k = 1;  // zoom level

    function zoomed(){
      	context.save();
 	context.clearRect(0, 0, width, height);
      	context.translate(d3.event.transform.x, d3.event.transform.y);
  	context.scale(d3.event.transform.k, d3.event.transform.k);
  	k = d3.event.transform.k;
  	drawLabels(k);
  	context.restore();
      // https://github.com/d3/d3-zoom#transform_invert
       	console.log("scale: ", k, "zoom transform: ", d3.event.transform.x, d3.event.transform.y);
    }



    function drawLabels(k){
        var font_size;
        context.clearRect(0, 0, width, height);
        

        for (var i = 0; i < label_array.length; i++) {

            context.fillStyle = colors[label_array[i].color];

            if(label_array[i].level < 3){ // in case of topic names

              font_size = font_size_b;
              font_size = font_size - 10*(label_array[i].level - 1);
              context.font = `${font_size}px "${main_font}"`;
              context.fillText(label_array[i].name, label_array[i].x, label_array[i].y - 0.8*font_size);

            } else {  //news items
              	font_size =  Math.floor(Math.sqrt( (font_size_s * k) )); 
              	context.font = `${font_size}px "${second_font}"`;
              	var boo = label_array[i]; 


              	for(var j = 0; j < boo.rows.length; j++){
                        var row = boo.rows[j].join(' ');
			if( j == nrows-1 ){  // add ... in case we've trimmed name 
					     // TODO:  change it in data preparation script
                          row += ' ...';
                        }
                	
			context.fillText(row, 
						boo.x, 
						boo.y - boo.height + j * font_size * (1+between_lines_interval));

              	}
              	// and site name
                context.font = `${font_size}px "${second_font}"`;
                context.fillStyle = 'gray';
		context.fillText(boo.url, boo.x, 
			         boo.y - boo.height + j * font_size * (1 + between_lines_interval));

            }


        }


     }


    // Functions
     function zoom_to(x, y, k){
	var zoommer = function(){

      	    context.save();
 	    context.clearRect(0, 0, width, height);
	    context.translate(x, y);
	    context.scale(k, k);
      	    drawLabels(k);
  	    context.restore();

	};

        return zoommer;

     }


    function get_translation(label, width, height, k){


      var rx = (label.x + 50)/width, ry = label.y/height;  // +50 - to position on center of word

      var xn = width*(0.5 - rx*k); 
      var yn = height*(0.5 - ry*k); 

      return {x:xn, y:yn};

    }


    d3.json("./labels.json").then(function(data) {

      label_array = data;

      canvas = d3.select("body").append("canvas")
            .attr("width", width)
            .attr("height", height);

      //canvas.on("mousemove",function(){
      //});

      context = canvas.node().getContext("2d");

      canvas.call(d3.zoom()
         .scaleExtent([0.5, 4])
           .on("zoom", zoomed));

      // initial view 

      var scale = 0.5;
      var zoomWidth = (width-scale*width)/2, zoomHeight = (height-scale*height)/2;       	
      (zoom_to(zoomWidth, zoomHeight, scale))();


      var k = 3.5;

      // translate to saakashvili
      var new_point = get_translation(label_array[728], width, height, k)
      //var new_point = get_translation(286/width, 83/height,  width, height, k)
      //setTimeout(zoom_to(new_point.x, new_point.y, k), 2000);


      // translate to Poroshenko
      new_point = get_translation(label_array[730], width, height, k)
      //setTimeout(zoom_to(new_point.x, new_point.y, k), 5000);

      // 'На Украине ...'	
      new_point = get_translation(label_array[741], width, height, k)
      //setTimeout(zoom_to(new_point.x, new_point.y, k), 7000);

      //drawLabels(1);
    });


/*
for(var j = 0; j < label_array.length; j++){
  if(label_array[j].name == "Саакашвілі"){ console.log("Саакашвілі:", j)};
  if(label_array[j].name == "Порошенко"){ console.log("Порошенко:", j)};
  if(label_array[j].name == "'На Украине' все погано"){ console.log("НА ... :", j)};
}
*/
</script>
